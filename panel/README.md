# /Users/mac/projects/ticket_bot/README.md
# Telegram VPN Ticket Bot

Этот проект представляет собой готового к использованию Telegram-бота, разработанного как система тикетов для VPN-сервиса. Бот написан на Python с использованием фреймворка aiogram 3.x.

## Оглавление
- [Фуционал](#функционал)
  - [Клиент](#клиент)
  - [Администратор](#администратор)
- [Технологический стек](#технологический-стек)
- [Установка и запуск](#установка-и-запуск)
  - [Предварительные требования](#предварительные-требования)
  - [Конфигурация](#конфигурация)
  - [Запуск](#запуск)
- [Структура проекта](#структура-проекта)

## Функционал

Бот предоставляет два набора функций в зависимости от роли пользователя: Клиент или Администратор.

### Клиент
- **Создание тикетов**: Может создавать несколько тикетов для обращения в поддержку.
- **Общение в тикетах**: Может отправлять текстовые сообщения, фотографии, видео и документы в рамках активного тикета.
- **Управление тикетами**: Может переключаться между своими тикетами, закрывать их и переоткрывать при необходимости.
- **Просмотр подписки**: Может проверить дату окончания своей VPN-подписки и количество оставшихся дней.
- **Уведомления**: Получает уведомления об ответах администратора, а также напоминания за 1 день и в день окончания подписки.

### Администратор
- **Полный доступ**: Администраторы определяются по их Telegram ID и имеют доступ ко всем функциям.
- **Обработка тикетов**: Может отвечать на тикеты пользователей, закрывать и переоткрывать их.
- **Просмотр списков**: Имеет доступ к спискам:
  - Открытых тикетов
  - Закрытых тикетов
  - Пользователей с истекающей подпиской
- **Прямая связь**: Может написать любому пользователю напрямую, вне рамок тикета.
- **Уведомления**: Получает уведомления о новых сообщениях от клиентов и о тикетах, требующих ответа (SLA).

## Технологический стек
- **Язык**: Python 3.11
- **Фреймворк**: Aiogram 3.x
- **База данных**: SQLite (с асинхронным доступом)
- **ORM**: SQLAlchemy 2.0
- **Фоновые задачи**: APScheduler
- **Деплой**: Docker, Docker Compose

## Установка и запуск

### Предварительные требования
- Установленный Docker и Docker Compose.

### Конфигурация
1. **Создайте файл `.env`**:
   Скопируйте файл `.env.example` и переименуйте его в `.env`:
   ```bash
   cp .env.example .env
   ```

2. **Заполните переменные окружения**:
   Откройте файл `.env` и укажите ваши данные:
   - `BOT_TOKEN`: Токен вашего Telegram-бота. Получить его можно у [@BotFather](https://t.me/BotFather).
   - `ADMIN_IDS`: Список Telegram ID администраторов через запятую. **Пример**: `12345678,87654321`.
   - `SLA_HOURS`: Время в часах, через которое сработает напоминание для администратора, если на тикет не ответили. По умолчанию `12`.

### Запуск
1. **Сборка и запуск контейнера**:
   Выполните следующую команду в корневой директории проекта:
   ```bash
   docker-compose up --build -d
   ```
   Эта команда соберёт Docker-образ, запустит контейнер в фоновом режиме и создаст volume для персистентного хранения базы данных SQLite.

2. **Проверка логов (опционально)**:
   Чтобы убедиться, что бот запустился без ошибок, вы можете посмотреть его логи:
   ```bash
   docker-compose logs -f
   ```

3. **Остановка**:
   Для остановки бота и удаления контейнера выполните:
   ```bash
   docker-compose down
   ```
   При этом данные в volume (база данных) сохранятся. Чтобы удалить и их, используйте `docker-compose down -v`.

## Структура проекта
```
/
├── app/                  # Основная директория с исходным кодом
│   ├── database/         # Модули для работы с БД
│   │   ├── crud.py       # Функции CRUD (создание, чтение, обновление, удаление)
│   │   ├── database.py   # Настройка подключения к БД
│   │   └── models.py     # Модели SQLAlchemy
│   ├── handlers/         # Обработчики сообщений и колбэков
│   │   ├── admin.py      # Логика для администраторов
│   │   └── client.py     # Логика для клиентов
│   ├── keyboards/        # Модули для создания клавиатур
│   │   ├── admin_kb.py
│   │   └── client_kb.py
│   ├── services/         # Фоновые задачи
│   │   ├── notifications.py # Проверка SLA и подписок
│   │   └── scheduler.py  # Настройка APScheduler
│   ├── states/           # Состояния FSM
│   │   └── states.py
│   ├── config.py         # Загрузка конфигурации из .env
│   └── main.py           # Точка входа в приложение
├── .env.example          # Пример файла с переменными окружения
├── .gitignore
├── docker-compose.yml    # Файл Docker Compose
├── Dockerfile            # Файл Docker для сборки образа
├── requirements.txt      # Зависимости Python
└── README.md             # Этот файл
```
